<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMVCMPC - Account</title>
    <link rel="stylesheet" href="/shared/css/main.css">
    <link rel="stylesheet" href="/shared/css/account.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        // Prevent flickering by setting navigation state immediately
        (function() {
            const isExpanded = localStorage.getItem('navExpanded') === 'true';
            if (isExpanded) {
                document.documentElement.classList.add('nav-expanded');
            }
        })();
    </script>
</head>
<body>
    <!-- Main Dashboard -->
    <div id="mainScreen" class="screen active">
        <!-- Navigation -->
        <nav class="navigation">
            <div class="nav-header">
                <div class="nav-logo">
                    <img src="/assets/logo.png" alt="IMVCMPC Logo">
                    <span class="logo-text">IMVCMPC</span>
                </div>
                <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            
            <div class="nav-menu">
                <!-- Navigation items will be dynamically populated based on role -->
                <div id="nav-items-container">
                    <!-- Items will be inserted here by JavaScript -->
                </div>
            </div>
            
            <div class="nav-account">
                <a href="#" class="nav-item active" onclick="window.location.href=getAccountUrl(); return false;">
                    <i class="fas fa-user-circle"></i>
                    <span>Account</span>
                </a>
            </div>
            
            <div class="nav-footer">
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="breadcrumb">
                    <div class="datetime-display">
                        <div class="date-display" id="currentDate"></div>
                        <div class="time-display" id="currentTime"></div>
                    </div>
                </div>
                <div class="user-profile">
                    <div class="user-info">
                        <span class="user-name" id="userName">Loading...</span>
                        <span class="user-role" id="userRole">Loading...</span>
                    </div>
                    <div class="user-avatar" id="userAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <!-- Mobile dropdown for user info -->
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-content">
                            <div class="dropdown-user-info">
                                <span class="dropdown-user-name" id="dropdownUserName">User</span>
                                <span class="dropdown-user-role" id="dropdownUserRole">IMVCMPC - Main Branch</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Content -->
            <div class="account-content">
                <div class="account-header">
                    <h1>Account Settings</h1>
                    <p id="accountDescription">Loading account information...</p>
                </div>

                <div class="account-grid">
                    <!-- Personal Information Section -->
                    <div class="account-section personal-section">
                        <div class="section-header">
                            <h2><i class="fas fa-user"></i> Personal Information</h2>
                            <div class="section-actions">
                                <button id="cancelBtn" class="btn-cancel" onclick="onCancelEdit()" style="display: none;">
                                    <i class="fas fa-times"></i>
                                    <span>Cancel</span>
                                </button>
                                <button id="editBtn" class="btn-edit" onclick="onEditOrUpdateClick()">
                                    <i class="fas fa-edit"></i>
                                    <span id="editBtnText">Edit</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="personal-content">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" id="fullName" class="edit-input" placeholder="Enter your full name" disabled>
                            </div>
                            <div class="form-group">
                                <label>Role</label>
                                <input type="text" id="role" class="edit-input" value="User" readonly>
                            </div>
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" id="username" class="edit-input" placeholder="Enter username" disabled>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="email" class="edit-input" placeholder="Enter email address" disabled>
                            </div>
                            <div class="form-group">
                                <label>Branch Location</label>
                                <input type="text" id="branchLocation" class="edit-input" value="Main Branch IBAAN" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Change Password Section -->
                    <div class="account-section status-section">
                        <div class="section-header">
                            <h2><i class="fas fa-key"></i> Change Password</h2>
                        </div>
                        
                        <div class="status-content">
                            <div class="form-group">
                                <label>Current Password</label>
                                <div class="password-input-wrapper">
                                    <input type="password" id="currentPassword" placeholder="Enter current password" class="edit-input password-field">
                                    <i class="fas fa-eye-slash toggle-password" onclick="togglePassword('currentPassword', this)"></i>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>New Password</label>
                                <div class="password-input-wrapper">
                                    <input type="password" id="newPassword" placeholder="Enter new password" class="edit-input password-field">
                                    <i class="fas fa-eye-slash toggle-password" onclick="togglePassword('newPassword', this)"></i>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Confirm Password</label>
                                <div class="password-input-wrapper">
                                    <input type="password" id="confirmPassword" placeholder="Confirm new password" class="edit-input password-field">
                                    <i class="fas fa-eye-slash toggle-password" onclick="togglePassword('confirmPassword', this)"></i>
                                </div>
                            </div>
                            <div class="change-password-actions">
                                <button class="btn btn-primary" onclick="handleChangePassword()">
                                    <i class="fas fa-key"></i>
                                    <span>Change Password</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Account Status Section with Note -->
                    <div class="status-with-note-wrapper">
                        <div class="account-section status-section">
                            <div class="section-header">
                                <h2><i class="fas fa-shield-alt"></i> Account Status</h2>
                            </div>
                            
                            <div class="status-content">
                                <div class="form-group">
                                    <label>Security Status</label>
                                    <span class="info-value" id="securityStatus">Active</span>
                                </div>
                                <div class="form-group">
                                    <label>Last Login</label>
                                    <span class="info-value" id="lastLogin">—</span>
                                </div>
                                <div class="form-group">
                                    <label>Session Duration</label>
                                    <span class="info-value" id="sessionDuration">—</span>
                                </div>
                            </div>
                        </div>

                        <!-- Account Information Note -->
                        <div class="account-section account-info-note">
                            <div class="section-header">
                                <h2><i class="fas fa-info-circle"></i> Account Guidelines</h2>
                            </div>
                            <div class="status-content">
                                <p>Password Requirements: Minimum 8 characters. Must be different from your current password.</p>
                                <p>Profile Updates: Personal information can be updated once every 30 days.</p>
                                <p>Update Frequency: Password and profile changes are limited to once every 30 days for security purposes.</p>
                                <p class="note-italic">Note: Account modifications are applied immediately upon saving.</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <script src="/shared/js/audit-logger.js"></script>
    <script src="/shared/js/main.js"></script>
    <script src="/shared/js/shared-utils.js"></script>
    <script src="/shared/js/topbar.js"></script>
    <script>
        // Helper function to get account URL based on role
        function getAccountUrl() {
            const userRole = localStorage.getItem('user_role');
            if (userRole === 'Finance Officer') {
                return '/financeofficer/account';
            } else if (userRole === 'Marketing Clerk') {
                return '/marketingclerk/account';
            } else if (userRole === 'IT Head') {
                return '/ithead/account';
            }
            return '/marketingclerk/account'; // default
        }
    </script>
    <script>
        // Format branch display to match IT Head
        function formatBranchDisplay({ isMain, name, location, number, id }) {
            const loc = (location || '').toString().trim();
            const locUpper = loc ? loc.toUpperCase() : '';
            const nameStr = (name || '').toString().trim();
            const isMainBranch = !!isMain || /\bmain\b/i.test(nameStr);
            if (isMainBranch) return `Main Branch ${locUpper || 'IBAAN'}`.trim();
            let branchNum = number;
            if (!branchNum && nameStr) {
                const m = nameStr.match(/branch\s*(\d+)/i);
                if (m) branchNum = m[1];
            }
            if (!branchNum && typeof id !== 'undefined' && id !== null) {
                const n = parseInt(id, 10);
                if (!isNaN(n) && n > 0) branchNum = n;
            }
            if (branchNum) return `Branch ${branchNum} ${locUpper || ''}`.trim();
            if (nameStr) return `${nameStr} ${locUpper || ''}`.trim();
            return locUpper || 'Main Branch IBAAN';
        }

        let isEditMode = false;
        let originalData = {};
        let detachListeners = null;

        async function loadUserInfo() {
            try {
                const storedUserRaw = localStorage.getItem('user');
                let storedUser = {};
                try { storedUser = storedUserRaw ? JSON.parse(storedUserRaw) : {}; } catch (_) {}
                const loginUsername = localStorage.getItem('login_username');

                const defaultFullName = (storedUser.first_name && storedUser.last_name) ? `${storedUser.first_name} ${storedUser.last_name}`.trim() : '';
                const defaultRole = storedUser.role_display_name || storedUser.role || (localStorage.getItem('user_role') || 'User');
                const defaultUsername = storedUser.username || loginUsername || '';
                const defaultEmail = storedUser.email || '';
                const defaultBranch = formatBranchDisplay({
                    isMain: storedUser.is_main_branch_user,
                    name: storedUser.branch_name,
                    location: storedUser.branch_location,
                    number: storedUser.branch_number,
                    id: storedUser.branch_id
                });

                document.getElementById('fullName').value = defaultFullName;
                document.getElementById('role').value = defaultRole;
                document.getElementById('username').value = defaultUsername;
                document.getElementById('email').value = defaultEmail;
                document.getElementById('branchLocation').value = defaultBranch;

                originalData = { fullName: defaultFullName, username: defaultUsername, email: defaultEmail };

                const token = localStorage.getItem('access_token');
                if (!token) {
                    updateHeader(defaultRole, storedUser.branch_name, storedUser.branch_location, storedUser.is_main_branch_user, storedUser.branch_id);
                    updateAccountStatus();
                    return;
                }

                const response = await fetch('/api/auth/me', { headers: { 'Authorization': `Bearer ${token}` } });
                if (response.ok) {
                    const data = await response.json();
                    const fullName = (data.first_name && data.last_name) ? `${data.first_name} ${data.last_name}`.trim() : defaultFullName;
                    const role = data.role_display_name || data.role || defaultRole;
                    const username = data.username || defaultUsername;
                    const email = data.email || defaultEmail;
                    const branchDisplay = formatBranchDisplay({
                        isMain: data.is_main_branch_user,
                        name: data.branch_name,
                        location: data.branch_location,
                        number: data.branch_number,
                        id: data.branch_id
                    });
                    document.getElementById('fullName').value = fullName;
                    document.getElementById('role').value = role;
                    document.getElementById('username').value = username;
                    document.getElementById('email').value = email;
                    document.getElementById('branchLocation').value = branchDisplay;
                    originalData = { fullName, username, email };
                    updateHeader(role, data.branch_name, data.branch_location, data.is_main_branch_user, data.branch_id);
                } else {
                    updateHeader(defaultRole, storedUser.branch_name, storedUser.branch_location, storedUser.is_main_branch_user, storedUser.branch_id);
                }
                updateAccountStatus();
            } catch (e) {
                console.error('Error loading user info:', e);
                updateAccountStatus();
            }
        }

        function updateHeader(userRole, branchName, branchLocation, isMain, branchId) {
            const headerText = formatBranchDisplay({ isMain, name: branchName, location: branchLocation, number: null, id: branchId });
            const nameEl = document.getElementById('userName');
            const roleEl = document.getElementById('userRole');
            const dropdownName = document.getElementById('dropdownUserName');
            const dropdownRole = document.getElementById('dropdownUserRole');
            if (nameEl) nameEl.textContent = userRole || 'User';
            if (roleEl) roleEl.textContent = `IMVCMPC - ${headerText}`;
            if (dropdownName) dropdownName.textContent = userRole || 'User';
            if (dropdownRole) dropdownRole.textContent = `IMVCMPC - ${headerText}`;
            const desc = document.getElementById('accountDescription');
            if (desc) desc.textContent = `Manage your ${String(userRole || 'User').toLowerCase()} account preferences and security settings.`;
        }

        // Edit/Update/Cancel flow
        function updateEditButtonDirtyState() {
            const fullName = document.getElementById('fullName').value.trim();
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const isDirty = (
                fullName !== (originalData.fullName || '') ||
                username !== (originalData.username || '') ||
                email !== (originalData.email || '')
            );
            const btn = document.getElementById('editBtn');
            const btnText = document.getElementById('editBtnText');
            if (!btn || !btnText) return;
            if (isEditMode) {
                btnText.textContent = 'Update';
                btn.disabled = !isDirty;
            } else {
                btnText.textContent = 'Edit';
                btn.disabled = false;
            }
        }

        function enterEditMode() {
            if (isEditMode) return;
            isEditMode = true;
            const fullNameInput = document.getElementById('fullName');
            const usernameInput = document.getElementById('username');
            const emailInput = document.getElementById('email');
            const cancelBtn = document.getElementById('cancelBtn');
            originalData = { fullName: fullNameInput.value, username: usernameInput.value, email: emailInput.value };
            fullNameInput.disabled = false; usernameInput.disabled = false; emailInput.disabled = false;
            if (cancelBtn) cancelBtn.style.display = 'inline-flex';
            const handler = updateEditButtonDirtyState;
            fullNameInput.addEventListener('input', handler);
            usernameInput.addEventListener('input', handler);
            emailInput.addEventListener('input', handler);
            detachListeners = () => {
                fullNameInput.removeEventListener('input', handler);
                usernameInput.removeEventListener('input', handler);
                emailInput.removeEventListener('input', handler);
                detachListeners = null;
            };
            updateEditButtonDirtyState();
        }

        function exitEditMode() {
            if (!isEditMode) return;
            isEditMode = false;
            const fullNameInput = document.getElementById('fullName');
            const usernameInput = document.getElementById('username');
            const emailInput = document.getElementById('email');
            const cancelBtn = document.getElementById('cancelBtn');
            if (typeof detachListeners === 'function') detachListeners();
            fullNameInput.disabled = true; usernameInput.disabled = true; emailInput.disabled = true;
            if (cancelBtn) cancelBtn.style.display = 'none';
            updateEditButtonDirtyState();
        }

        function onEditOrUpdateClick() {
            if (!isEditMode) { enterEditMode(); return; }
            const btn = document.getElementById('editBtn');
            if (btn && !btn.disabled) savePersonalInfo();
        }

        function onCancelEdit() {
            try {
                document.getElementById('fullName').value = originalData.fullName || '';
                document.getElementById('username').value = originalData.username || '';
                document.getElementById('email').value = originalData.email || '';
            } catch {}
            exitEditMode();
        }

        async function savePersonalInfo() {
            const fullName = document.getElementById('fullName').value.trim();
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            if (!fullName || !username || !email) { showErrorDialog('Please fill in all required fields'); return; }
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) { showErrorDialog('Please enter a valid email address'); return; }
            try {
                const token = localStorage.getItem('access_token');
                if (!token) { showErrorDialog('Unauthorized'); return; }
                const [firstName, ...rest] = fullName.split(' ');
                const lastName = rest.join(' ');
                const resp = await fetch('/api/auth/update-profile', {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ first_name: firstName || '', last_name: lastName || '', username, email })
                });
                if (resp.ok) {
                    showSuccessDialog('Profile updated successfully');
                    originalData = { fullName, username, email };
                    exitEditMode();
                } else {
                    try {
                        const err = await resp.json();
                        const errorMessage = err.error || err.detail || 'Failed to update profile';
                        showErrorDialog(errorMessage);
                    } catch (parseError) {
                        showErrorDialog('Failed to update profile');
                    }
                }
            } catch (e) {
                console.error('Update error:', e);
                showErrorDialog('Failed to update profile');
            }
        }

        // Change password
        async function handleChangePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (!currentPassword || !newPassword || !confirmPassword) { showErrorDialog('Please fill in all password fields'); return; }
            if (newPassword !== confirmPassword) { showErrorDialog('New passwords do not match'); return; }
            if (newPassword.length < 8) { showErrorDialog('Password must be at least 8 characters long'); return; }
            try {
                const token = localStorage.getItem('access_token');
                if (!token) { showErrorDialog('Unauthorized'); return; }
                const resp = await fetch('/api/auth/change-password', {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
                });
                if (resp.ok) {
                    showSuccessDialog('Password changed successfully');
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    try {
                        const err = await resp.json();
                        const errorMessage = err.error || err.detail || 'Failed to change password';
                        showErrorDialog(errorMessage);
                    } catch (parseError) {
                        showErrorDialog('Failed to change password');
                    }
                }
            } catch (e) {
                console.error('Change password error:', e);
                showErrorDialog('Failed to change password');
            }
        }

        function togglePassword(inputId, icon) {
            const input = document.getElementById(inputId);
            if (!input) return;
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            }
        }

        function showNotification(message, type) {
            const n = document.createElement('div');
            n.style.cssText = `position:fixed;top:100px;right:20px;padding:16px 24px;border-radius:12px;background:${type==='success'?'#69B41E':'#EF4444'};color:#fff;font-size:14px;font-weight:500;box-shadow:0 8px 24px rgba(0,0,0,.15);z-index:10001;animation:slideInRight .3s ease;`;
            n.textContent = message; document.body.appendChild(n);
            setTimeout(()=>{ n.style.animation='slideOutRight .3s ease'; setTimeout(()=>n.remove(),300); },3000);
        }

        // Show minimalist success dialog
        function showSuccessDialog(message) {
            const existingDialog = document.getElementById('successDialog');
            if (existingDialog) existingDialog.remove();
            
            const overlay = document.createElement('div');
            overlay.id = 'successDialog';
            overlay.style.cssText = `position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:flex;justify-content:center;align-items:center;z-index:10000;animation:fadeIn 0.2s ease;`;
            
            const dialog = document.createElement('div');
            dialog.style.cssText = `background:white;border-radius:12px;padding:24px;max-width:400px;width:90%;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.15);opacity:0;transform:scale(0.95);transition:all 0.2s ease;`;
            
            setTimeout(() => { dialog.style.opacity = '1'; dialog.style.transform = 'scale(1)'; }, 10);
            
            const icon = document.createElement('div');
            icon.style.cssText = `width:40px;height:40px;background:#f0fdf4;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;`;
            icon.innerHTML = '<i class="fas fa-check-circle" style="color:#0D5B11;font-size:18px;"></i>';
            
            const messageEl = document.createElement('p');
            messageEl.style.cssText = `color:#374151;font-size:14px;font-weight:500;margin:0 0 20px 0;line-height:1.5;`;
            messageEl.textContent = message;
            
            const button = document.createElement('button');
            button.textContent = 'OK';
            button.style.cssText = `background:#0D5B11;color:white;border:none;border-radius:6px;padding:8px 20px;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s ease;`;
            button.onmouseover = () => button.style.background = '#0a4a0e';
            button.onmouseout = () => button.style.background = '#0D5B11';
            
            const handleEscape = (e) => { if (e.key === 'Escape') { overlay.remove(); document.removeEventListener('keydown', handleEscape); } };
            button.onclick = () => { overlay.remove(); document.removeEventListener('keydown', handleEscape); };
            overlay.onclick = (e) => { if (e.target === overlay) { overlay.remove(); document.removeEventListener('keydown', handleEscape); } };
            document.addEventListener('keydown', handleEscape);
            
            if (!document.getElementById('fadeInStyle')) {
                const style = document.createElement('style');
                style.id = 'fadeInStyle';
                style.textContent = '@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }';
                document.head.appendChild(style);
            }
            
            dialog.appendChild(icon);
            dialog.appendChild(messageEl);
            dialog.appendChild(button);
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
        }

        // Show minimalist error dialog
        function showErrorDialog(message) {
            const existingDialog = document.getElementById('errorDialog');
            if (existingDialog) existingDialog.remove();
            
            const overlay = document.createElement('div');
            overlay.id = 'errorDialog';
            overlay.style.cssText = `position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:flex;justify-content:center;align-items:center;z-index:10000;animation:fadeIn 0.2s ease;`;
            
            const dialog = document.createElement('div');
            dialog.style.cssText = `background:white;border-radius:12px;padding:24px;max-width:400px;width:90%;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.15);opacity:0;transform:scale(0.95);transition:all 0.2s ease;`;
            
            setTimeout(() => { dialog.style.opacity = '1'; dialog.style.transform = 'scale(1)'; }, 10);
            
            const icon = document.createElement('div');
            icon.style.cssText = `width:40px;height:40px;background:#fef2f2;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;`;
            icon.innerHTML = '<i class="fas fa-exclamation-circle" style="color:#ef4444;font-size:18px;"></i>';
            
            const messageEl = document.createElement('p');
            messageEl.style.cssText = `color:#374151;font-size:14px;font-weight:500;margin:0 0 20px 0;line-height:1.5;`;
            messageEl.textContent = message;
            
            const button = document.createElement('button');
            button.textContent = 'OK';
            button.style.cssText = `background:#0D5B11;color:white;border:none;border-radius:6px;padding:8px 20px;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s ease;`;
            button.onmouseover = () => button.style.background = '#0a4a0e';
            button.onmouseout = () => button.style.background = '#0D5B11';
            
            const handleEscape = (e) => { if (e.key === 'Escape') { overlay.remove(); document.removeEventListener('keydown', handleEscape); } };
            button.onclick = () => { overlay.remove(); document.removeEventListener('keydown', handleEscape); };
            overlay.onclick = (e) => { if (e.target === overlay) { overlay.remove(); document.removeEventListener('keydown', handleEscape); } };
            document.addEventListener('keydown', handleEscape);
            
            if (!document.getElementById('fadeInStyle')) {
                const style = document.createElement('style');
                style.id = 'fadeInStyle';
                style.textContent = '@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }';
                document.head.appendChild(style);
            }
            
            dialog.appendChild(icon);
            dialog.appendChild(messageEl);
            dialog.appendChild(button);
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
        }

        function updateAccountStatus() {
            const statusEl = document.getElementById('securityStatus');
            if (statusEl) statusEl.textContent = 'Active';
            const lastLoginIso = localStorage.getItem('lastLoginTime');
            const lastLoginEl = document.getElementById('lastLogin');
            if (lastLoginIso && lastLoginEl) {
                const d = new Date(lastLoginIso);
                lastLoginEl.textContent = d.toLocaleString();
            } else if (lastLoginEl) {
                lastLoginEl.textContent = '—';
            }
            const sessionEl = document.getElementById('sessionDuration');
            if (sessionEl && lastLoginIso) {
                const ms = Date.now() - new Date(lastLoginIso).getTime();
                const mins = Math.floor(ms / 60000);
                const hours = Math.floor(mins / 60);
                const rem = mins % 60;
                sessionEl.textContent = hours > 0 ? `${hours}h ${rem}m` : `${rem}m`;
            }
            const attemptsEl = document.getElementById('loginAttempts');
            if (attemptsEl) attemptsEl.textContent = '1 (Successful)';
        }

        function updateDateTime() {
            const now = new Date();
            const dateElement = document.getElementById('currentDate');
            const timeElement = document.getElementById('currentTime');
            if (dateElement) dateElement.textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            if (timeElement) timeElement.textContent = now.toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            loadUserInfo();
            initializeTopBar(); // Initialize topbar dropdown for mobile
        });

        // Expose handlers
        window.onEditOrUpdateClick = onEditOrUpdateClick;
        window.onCancelEdit = onCancelEdit;
        window.handleChangePassword = handleChangePassword;
        window.togglePassword = togglePassword;
    </script>

    <!-- Live Reload for Development -->
    <script src="/shared/js/live-reload.js"></script>

</body>
</html>