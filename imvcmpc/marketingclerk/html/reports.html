<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMVCMPC - Reports</title>
    <link rel="stylesheet" href="../../shared/css/main.css">
    <link rel="stylesheet" href="../css/reports.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        // Prevent flickering by setting navigation state immediately
        (function() {
            const isExpanded = localStorage.getItem('navExpanded') === 'true';
            if (isExpanded) {
                document.documentElement.classList.add('nav-expanded');
            }
        })();
    </script>
</head>
<body>
    <!-- Main Dashboard -->
    <div id="mainScreen" class="screen active">
        <!-- Navigation -->
        <nav class="navigation">
            <div class="nav-header">
                <div class="nav-logo">
                    <img src="../../assets/logo.png" alt="IMVCMPC Logo">
                    <span class="logo-text">IMVCMPC</span>
                </div>
                <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            
            <div class="nav-menu">
                <!-- Navigation items will be dynamically populated based on role -->
                <div id="nav-items-container">
                    <!-- Items will be inserted here by JavaScript -->
                </div>
            </div>
            
            <div class="nav-account">
                <a href="account.html" class="nav-item">
                    <i class="fas fa-user-circle"></i>
                    <span>Account</span>
                </a>
            </div>
            
            <div class="nav-footer">
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="breadcrumb">
                    <div class="datetime-display">
                        <div class="date-display" id="currentDate"></div>
                        <div class="time-display" id="currentTime"></div>
                    </div>
                </div>
                <div class="user-profile">
                    <div class="user-info">
                        <span class="user-name" id="userName">User</span>
                        <span class="user-role" id="userRole">IMVCMPC - Main Branch</span>
                    </div>
                    <div class="user-avatar" id="userAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <!-- Mobile dropdown for user info -->
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-content">
                            <div class="dropdown-user-info">
                                <span class="dropdown-user-name" id="dropdownUserName">User</span>
                                <span class="dropdown-user-role" id="dropdownUserRole">IMVCMPC - Main Branch</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Content -->
            <div class="reports-content">
                <div class="reports-header">
                    <div class="header-left">
                        <h1>Reports</h1>
                        <p>Generate financial reports for savings, disbursements, members, and branch performance.</p>
                    </div>
                    <div class="header-right">
                        <!-- Report Type Filter -->
                        <div class="report-type-filter">
                            <button class="report-type-btn" onclick="toggleReportTypeMenu()" id="reportTypeBtn">
                                <span id="reportTypeText">Request Report</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="report-type-menu" id="reportTypeMenu">
                                <div class="menu-section">
                                    <div class="menu-option" data-type="" onclick="selectReportType('')">
                                        <span>Request Report</span>
                                        <i class="fas fa-check check-icon" style="display: none;"></i>
                                    </div>
                                    <div class="menu-option" data-type="savings" onclick="selectReportType('savings')">
                                        <span>Savings Report</span>
                                        <i class="fas fa-check check-icon" style="display: none;"></i>
                                    </div>
                                    <div class="menu-option" data-type="disbursement" onclick="selectReportType('disbursement')">
                                        <span>Disbursement Report</span>
                                        <i class="fas fa-check check-icon" style="display: none;"></i>
                                    </div>
                                    <div class="menu-option" data-type="member" onclick="selectReportType('member')">
                                        <span>Member Report</span>
                                        <i class="fas fa-check check-icon" style="display: none;"></i>
                                    </div>
                                    <div class="menu-option" id="branchReportOption" data-type="branch" style="display: none;" onclick="selectReportType('branch')">
                                        <span>Branch Report</span>
                                        <i class="fas fa-check check-icon" style="display: none;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date Range Filter -->
                <div class="date-range-filter" id="dateRangeFilter">
                    <div class="date-input-group">
                        <label for="startDate">From:</label>
                        <input type="date" id="startDate" class="date-input">
                    </div>
                    <div class="date-input-group">
                        <label for="endDate">To:</label>
                        <input type="date" id="endDate" class="date-input">
                    </div>
                    <button class="apply-date-filter-btn" onclick="applyDateFilter()">
                        <i class="fas fa-filter"></i>
                        <span>Apply</span>
                    </button>
                    <button class="clear-date-filter-btn" onclick="clearDateFilter()">
                        <i class="fas fa-times"></i>
                        <span>Clear</span>
                    </button>
                    <div class="report-count" id="reportCount" style="margin-left:auto; color:#6B7280; font-weight:500; font-size:13px; visibility:hidden;"></div>
                </div>

                <!-- Report Configuration -->
                <div class="report-config">
                    <!-- Savings Configuration -->
                    <div id="savingsConfig" class="config-section">
                        <div class="config-header">
                            <h3>Savings Report Configuration</h3>
                            <button class="clear-config-btn" onclick="clearConfiguration('savings')" title="Clear all fields">
                                <i class="fas fa-eraser"></i>
                            </button>
                        </div>
                        <div class="config-content">
                            <!-- Branch indicator for non-main branch users -->
                            <div id="savingsBranchIndicator" class="branch-indicator" style="display: none;">
                                <i class="fas fa-building"></i>
                                <span>Viewing reports for: <strong id="savingsBranchName"></strong></span>
                            </div>
                            <!-- Month/Year Toggle -->
                            <div class="toggle-container">
                                <div class="month-year-toggle" id="savingsToggle">
                                    <button class="toggle-option active" data-option="month" onclick="toggleMonthYear('savings', 'month')">
                                        <span>Month</span>
                                    </button>
                                    <button class="toggle-option" data-option="year" onclick="toggleMonthYear('savings', 'year')">
                                        <span>Year</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Month Mode: Year (single) + Months (multiple) -->
                            <div class="selection-container" id="savingsMonthMode">
                                <div class="selection-group">
                                    <label>CHOOSE YEAR (One Selection Only)</label>
                                    <div class="year-buttons-container" id="savingsYearButtonsSingle">
                                        <!-- Year buttons will be populated dynamically -->
                                    </div>
                                </div>
                                <div class="selection-group">
                                    <label>CHOOSE MONTHS (Multiple Selection - 2 or more)</label>
                                    <div class="month-buttons-container" id="savingsMonthButtons">
                                        <button class="selection-btn" data-value="1" onclick="toggleMonthSelection('savings', 1)">January</button>
                                        <button class="selection-btn" data-value="2" onclick="toggleMonthSelection('savings', 2)">February</button>
                                        <button class="selection-btn" data-value="3" onclick="toggleMonthSelection('savings', 3)">March</button>
                                        <button class="selection-btn" data-value="4" onclick="toggleMonthSelection('savings', 4)">April</button>
                                        <button class="selection-btn" data-value="5" onclick="toggleMonthSelection('savings', 5)">May</button>
                                        <button class="selection-btn" data-value="6" onclick="toggleMonthSelection('savings', 6)">June</button>
                                        <button class="selection-btn" data-value="7" onclick="toggleMonthSelection('savings', 7)">July</button>
                                        <button class="selection-btn" data-value="8" onclick="toggleMonthSelection('savings', 8)">August</button>
                                        <button class="selection-btn" data-value="9" onclick="toggleMonthSelection('savings', 9)">September</button>
                                        <button class="selection-btn" data-value="10" onclick="toggleMonthSelection('savings', 10)">October</button>
                                        <button class="selection-btn" data-value="11" onclick="toggleMonthSelection('savings', 11)">November</button>
                                        <button class="selection-btn" data-value="12" onclick="toggleMonthSelection('savings', 12)">December</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Year Mode: Years (multiple) -->
                            <div class="selection-container" id="savingsYearMode" style="display: none;">
                                <div class="selection-group">
                                    <label>CHOOSE YEAR (One or More)</label>
                                    <div class="year-buttons-container" id="savingsYearButtonsMultiple">
                                        <!-- Year buttons will be populated dynamically -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div id="disbursementConfig" class="config-section">
                        <div class="config-header">
                            <h3>Disbursement Report Configuration</h3>
                            <button class="clear-config-btn" onclick="clearConfiguration('disbursement')" title="Clear all fields">
                                <i class="fas fa-eraser"></i>
                            </button>
                        </div>
                        <div class="config-content">
                            <!-- Branch indicator for non-main branch users -->
                            <div id="disbursementBranchIndicator" class="branch-indicator" style="display: none;">
                                <i class="fas fa-building"></i>
                                <span>Viewing reports for: <strong id="disbursementBranchName"></strong></span>
                            </div>
                            <!-- Month/Year Toggle -->
                            <div class="toggle-container">
                                <div class="month-year-toggle" id="disbursementToggle">
                                    <button class="toggle-option active" data-option="month" onclick="toggleMonthYear('disbursement', 'month')">
                                        <span>Month</span>
                                    </button>
                                    <button class="toggle-option" data-option="year" onclick="toggleMonthYear('disbursement', 'year')">
                                        <span>Year</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Month Mode: Year (single) + Months (multiple) -->
                            <div class="selection-container" id="disbursementMonthMode">
                                <div class="selection-group">
                                    <label>CHOOSE YEAR (One Selection Only)</label>
                                    <div class="year-buttons-container" id="disbursementYearButtonsSingle">
                                        <!-- Year buttons will be populated dynamically -->
                                    </div>
                                </div>
                                <div class="selection-group">
                                    <label>CHOOSE MONTHS (Multiple Selection - 2 or more)</label>
                                    <div class="month-buttons-container" id="disbursementMonthButtons">
                                        <button class="selection-btn" data-value="1" onclick="toggleMonthSelection('disbursement', 1)">January</button>
                                        <button class="selection-btn" data-value="2" onclick="toggleMonthSelection('disbursement', 2)">February</button>
                                        <button class="selection-btn" data-value="3" onclick="toggleMonthSelection('disbursement', 3)">March</button>
                                        <button class="selection-btn" data-value="4" onclick="toggleMonthSelection('disbursement', 4)">April</button>
                                        <button class="selection-btn" data-value="5" onclick="toggleMonthSelection('disbursement', 5)">May</button>
                                        <button class="selection-btn" data-value="6" onclick="toggleMonthSelection('disbursement', 6)">June</button>
                                        <button class="selection-btn" data-value="7" onclick="toggleMonthSelection('disbursement', 7)">July</button>
                                        <button class="selection-btn" data-value="8" onclick="toggleMonthSelection('disbursement', 8)">August</button>
                                        <button class="selection-btn" data-value="9" onclick="toggleMonthSelection('disbursement', 9)">September</button>
                                        <button class="selection-btn" data-value="10" onclick="toggleMonthSelection('disbursement', 10)">October</button>
                                        <button class="selection-btn" data-value="11" onclick="toggleMonthSelection('disbursement', 11)">November</button>
                                        <button class="selection-btn" data-value="12" onclick="toggleMonthSelection('disbursement', 12)">December</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Year Mode: Years (multiple) -->
                            <div class="selection-container" id="disbursementYearMode" style="display: none;">
                                <div class="selection-group">
                                    <label>CHOOSE YEAR (One or More)</label>
                                    <div class="year-buttons-container" id="disbursementYearButtonsMultiple">
                                        <!-- Year buttons will be populated dynamically -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                                        <div id="memberConfig" class="config-section">
                        <div class="config-header">
                            <h3>Member Report Configuration</h3>
                            <button class="clear-config-btn" onclick="clearConfiguration('member')" title="Clear all fields">
                                <i class="fas fa-eraser"></i>
                            </button>
                        </div>
                        <div class="config-content">
                            <div class="member-config-row">
                                <div class="filter-group">
                                    <label for="memberSearch">SEARCH MEMBER</label>
                                    <input type="text" id="memberSearch" placeholder="Enter member name or ID">
                                </div>
                                <div class="transaction-type">
                                    <label>TRANSACTION TYPE</label>
                                    <div class="type-display">
                                        <span class="type-badge active" data-type="savings">
                                            <i class="fas fa-piggy-bank"></i>
                                            <span>Savings</span>
                                        </span>
                                        <span class="type-badge active" data-type="disbursement">
                                            <i class="fas fa-money-bill-wave"></i>
                                            <span>Disbursement</span>
                                        </span>
                                    </div>
                                    <small class="help-text">Both transaction types are included in this report</small>
                                </div>
                            </div>
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label for="memberYear">YEAR</label>
                                    <select id="memberYear">
                                        <option value="2025">2025</option>
                                        <option value="2024">2024</option>
                                        <option value="2023">2023</option>
                                        <option value="2022">2022</option>
                                        <option value="2021">2021</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="memberMonth">MONTH</label>
                                    <select id="memberMonth">
                                        <option value="1">January</option>
                                        <option value="2">February</option>
                                        <option value="3">March</option>
                                        <option value="4">April</option>
                                        <option value="5">May</option>
                                        <option value="6">June</option>
                                        <option value="7">July</option>
                                        <option value="8">August</option>
                                        <option value="9">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div id="branchConfig" class="config-section">
                        <div class="config-header">
                            <h3>Branch Report Configuration</h3>
                            <button class="clear-config-btn" onclick="clearConfiguration('branch')" title="Clear all fields">
                                <i class="fas fa-eraser"></i>
                            </button>
                        </div>
                        <div class="config-content">
                            <div class="branch-selection">
                                <label>Select Branches (Multiple)</label>
                                <div class="branch-grid">
                                    <!-- Branches will be populated dynamically -->
                                </div>
                            </div>
                            <div class="branch-config-row">
                                <div class="filter-group">
                                    <label for="branchYear">YEAR</label>
                                    <select id="branchYear">
                                        <option value="2025">2025</option>
                                        <option value="2024">2024</option>
                                        <option value="2023">2023</option>
                                        <option value="2022">2022</option>
                                        <option value="2021">2021</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="branchMonth">MONTH</label>
                                    <select id="branchMonth">
                                        <option value="1">January</option>
                                        <option value="2">February</option>
                                        <option value="3">March</option>
                                        <option value="4">April</option>
                                        <option value="5">May</option>
                                        <option value="6">June</option>
                                        <option value="7">July</option>
                                        <option value="8">August</option>
                                        <option value="9">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                </div>
                                <div class="transaction-type">
                                    <label>Transaction Type (Can Select Both)</label>
                                    <div class="type-buttons" role="group" aria-label="Transaction type selection">
                                        <button class="type-btn" data-type="savings" type="button" aria-pressed="false" aria-label="Select savings transactions">
                                            <i class="fas fa-piggy-bank" aria-hidden="true"></i>
                                            <span>Savings</span>
                                        </button>
                                        <button class="type-btn" data-type="disbursement" type="button" aria-pressed="false" aria-label="Select disbursement transactions">
                                            <i class="fas fa-money-bill-wave" aria-hidden="true"></i>
                                            <span>Disbursement</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Request-only flow: no direct send button for marketing clerk -->

                <!-- Received Reports Section - Main Reports Page Only -->
                <div class="received-reports-section">
                    <div class="section-header">
                        <div class="section-title">
                            <h3><i class="fas fa-inbox"></i> Received Reports</h3>
                            <p>Reports generated by Finance Officer for your review</p>
                        </div>
                        <div class="section-controls">
                            <div class="report-filters">
                                <button class="filter-btn active" data-filter="all" onclick="filterReceivedReports('all')">All</button>
                                <button class="filter-btn" data-filter="savings" onclick="filterReceivedReports('savings')">Savings</button>
                                <button class="filter-btn" data-filter="disbursement" onclick="filterReceivedReports('disbursement')">Disbursement</button>
                                <button class="filter-btn" data-filter="member" onclick="filterReceivedReports('member')">Member</button>
                                <button class="filter-btn" data-filter="branch" onclick="filterReceivedReports('branch')">Branch</button>
                            </div>
                            <button onclick="loadReceivedReports()" class="refresh-btn" title="Refresh reports">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div id="receivedReportsContainer" class="received-reports-container">
                        <!-- Received reports will be displayed here -->
                    </div>
                </div>


            </div>
        </main>
    </div>

    <script src="../../shared/js/audit-logger.js"></script>
    <script src="../../shared/js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../../shared/js/shared-utils.js"></script>
    <script src="../js/reports.js"></script>
    <script src="../../shared/js/topbar.js"></script>
    <script>
        // Function to check if user is from main branch and show/hide branch reports
        function toggleBranchReports() {
            console.log('=== TOGGLING BRANCH REPORTS ===');
            
            // Get user data using the same logic as topbar
            let userRole = localStorage.getItem('user_role');
            let userBranchId = localStorage.getItem('user_branch_id');
            let userBranchName = localStorage.getItem('user_branch_name');
            let userBranchLocation = localStorage.getItem('user_branch_location');
            let isMainBranchUser = localStorage.getItem('is_main_branch_user') === 'true';

            // Correct the branch data based on location (fetch from API)
            if (userBranchLocation) {
                // Fetch branch data from API
                fetch('/api/auth/branches', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.branches) {
                        // Find branch by location
                        const correctBranch = result.branches.find(b => 
                            b.location === userBranchLocation
                        );
                        
                        if (correctBranch) {
                            userBranchId = correctBranch.id.toString();
                            userBranchName = correctBranch.name;
                            isMainBranchUser = correctBranch.is_main_branch || false;
                            
                            // Update localStorage with corrected values
                            localStorage.setItem('user_branch_id', userBranchId);
                            localStorage.setItem('user_branch_name', userBranchName);
                            localStorage.setItem('is_main_branch_user', isMainBranchUser.toString());
                            
                            // Continue with toggle logic
                            continueToggleBranchReports(userBranchId, userBranchName, isMainBranchUser);
                        } else {
                            continueToggleBranchReports(userBranchId, userBranchName, isMainBranchUser);
                        }
                    } else {
                        continueToggleBranchReports(userBranchId, userBranchName, isMainBranchUser);
                    }
                })
                .catch(error => {
                    console.error('Error fetching branch data:', error);
                    continueToggleBranchReports(userBranchId, userBranchName, isMainBranchUser);
                });
                
                return; // Exit early, continueToggleBranchReports will be called
            }
            
            // If no location, continue normally
            continueToggleBranchReports(userBranchId, userBranchName, isMainBranchUser);
        }
        
        // Helper function to continue with toggle logic after branch data is fetched
        function continueToggleBranchReports(userBranchId, userBranchName, isMainBranchUser) {
            const userBranchLocation = localStorage.getItem('user_branch_location');
            console.log('User is main branch:', isMainBranchUser);
            console.log('User branch location:', userBranchLocation);

            // Update localStorage with corrected values so reports.js uses them
            localStorage.setItem('user_branch_id', userBranchId);
            localStorage.setItem('user_branch_name', userBranchName);
            localStorage.setItem('is_main_branch_user', isMainBranchUser.toString());

            // Show/hide branch reports option in dropdown
            const branchReportOption = document.getElementById('branchReportOption');
            
            // Find and show/hide the Branch filter button
            const branchFilterBtn = document.querySelector('.report-filters button[data-filter="branch"]');

            if (isMainBranchUser) {
                // Show branch reports option for main branch users
                if (branchReportOption) {
                    branchReportOption.style.display = 'flex';
                    console.log('Showing branch reports option for main branch user');
                }
                // Show Branch filter button for main branch users
                if (branchFilterBtn) {
                    branchFilterBtn.style.display = 'flex';
                    console.log('Showing branch filter for main branch user');
                }
            } else {
                // Hide branch reports for non-main branch users
                if (branchReportOption) {
                    branchReportOption.style.display = 'none';
                    console.log('Hiding branch reports option for non-main branch user');
                }
                // Hide Branch filter button for non-main branch users
                if (branchFilterBtn) {
                    branchFilterBtn.style.display = 'none';
                    console.log('Hiding branch filter for non-main branch user');
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeTopBar();
            toggleBranchReports();
        });
    </script>

    <!-- Live Reload for Development -->
    <script src="/shared/js/live-reload.js"></script>

</body>
</html>